{% extends 'base.html' %}

{% block title %}Tests - MediGenAI{% endblock %}

{% block page_title %}Medical Tests{% endblock %}
{% block page_description %}Manage and track patient laboratory tests{% endblock %}

{% block extra_css %}
<style>
    .stats-wrapper {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        padding: 16px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                    0 0 1px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        margin-bottom: 12px;
    }

    .stats-grid {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 14px 12px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex: 1 1 calc(20% - 10px);
        min-width: 150px;
        border: 1px solid rgba(26, 54, 115, 0.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        background: linear-gradient(135deg, #1A3673 0%, #0f2347 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(26, 54, 115, 0.3);
    }

    .stat-info h3 {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .stat-info .stat-value {
        font-size: 26px;
        font-weight: 700;
        color: #1A3673;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08),
                    0 0 1px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(26, 54, 115, 0.1);
    }

    .card-header h3 {
        font-size: 16px;
        color: #1A3673;
        font-weight: 600;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
        font-size: 14px;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #1A3673;
        box-shadow: 0 0 0 3px rgba(26, 54, 115, 0.1);
    }

    .btn-primary {
        padding: 12px 24px;
        background: #1A3673;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(26, 54, 115, 0.3);
        background: #0f2347;
    }

    .btn-secondary {
        padding: 8px 16px;
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-secondary:hover {
        background: #4b5563;
        transform: translateY(-1px);
    }

    .btn-danger {
        padding: 8px 16px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-danger:hover {
        background: #b91c1c;
        transform: translateY(-1px);
    }

    .test-categories {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }

    .category-group {
        background: #f9fafb;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .category-title {
        font-weight: 600;
        color: #1A3673;
        margin-bottom: 8px;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .category-title:hover {
        background: rgba(26, 54, 115, 0.05);
    }

    .category-title input[type="checkbox"] {
        cursor: pointer;
    }

    .test-option {
        padding: 6px 0;
    }

    .test-option label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 13px;
        color: #374151;
    }

    .test-option input[type="checkbox"] {
        cursor: pointer;
        width: 16px;
        height: 16px;
    }

    .table-container {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #f9fafb;
    }

    th {
        padding: 12px 16px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }

    td {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 13px;
        color: #374151;
    }

    tr:hover {
        background: rgba(26, 54, 115, 0.02);
    }

    .status-badge {
        display: inline-block;
        padding: 5px 14px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.normal {
        background: #d1fae5;
        color: #065f46;
    }

    .status-badge.draft {
        background: #fef3c7;
        color: #92400e;
    }

    .status-badge.abnormal {
        background: #fed7aa;
        color: #92400e;
    }

    .status-badge.critical {
        background: #fecaca;
        color: #991b1b;
    }

    .success-message {
        padding: 12px;
        background: #d1fae5;
        color: #065f46;
        border-radius: 8px;
        margin-bottom: 16px;
        display: none;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        padding: 20px 24px;
        background: #1A3673;
        color: white;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 20px;
    }

    .modal-close {
        color: white;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }

    .modal-close:hover {
        color: #fed7aa;
    }

    .modal-body {
        padding: 24px;
    }

    .modal-body input[type="number"],
    .modal-body textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 13px;
    }

    .modal-body textarea {
        min-height: 60px;
        resize: vertical;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .stats-wrapper {
            flex-direction: column;
        }

        .actions-bar {
            flex-direction: column;
            gap: 12px;
        }

        .actions-bar .btn-primary,
        .actions-bar .btn-secondary,
        .actions-bar .btn-danger {
            width: 100%;
        }

        .filters {
            flex-direction: column;
        }

        .filter-select, .search-input {
            width: 100%;
        }

        .card {
            padding: 12px;
            overflow-x: auto;
        }

        .tests-table {
            font-size: 12px;
            min-width: 700px;
        }

        .tests-table th,
        .tests-table td {
            padding: 10px 8px;
        }

        .tests-table td:last-child {
            white-space: nowrap;
        }

        .tests-table .btn-secondary,
        .tests-table .btn-danger {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 4px;
        }

        .tests-table .btn-secondary i,
        .tests-table .btn-danger i {
            font-size: 11px;
        }

        .test-group-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .card-header {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 12px;
        }

        .card-header > div {
            width: 100%;
            flex-direction: column;
            gap: 8px;
        }

        .card-header .btn-primary,
        .card-header .btn-danger {
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        .tests-table {
            font-size: 11px;
        }

        .tests-table .btn-secondary,
        .tests-table .btn-danger {
            padding: 5px 10px;
            font-size: 11px;
        }

        .tests-table .btn-secondary i,
        .tests-table .btn-danger i {
            font-size: 10px;
        }

        .badge {
            font-size: 10px;
            padding: 4px 8px;
        }

        .modal-content {
            padding: 16px;
            max-width: 95%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-wrapper">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-vial"></i>
            </div>
            <div class="stat-info">
                <h3>Total Tests</h3>
                <div class="stat-value">{{ total_tests }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-edit"></i>
            </div>
            <div class="stat-info">
                <h3>Draft Tests</h3>
                <div class="stat-value">{{ draft_count }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>Published</h3>
                <div class="stat-value">{{ published_count }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h3>Abnormal</h3>
                <div class="stat-value">{{ abnormal_tests }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-heartbeat"></i>
            </div>
            <div class="stat-info">
                <h3>Critical</h3>
                <div class="stat-value">{{ critical_tests }}</div>
            </div>
        </div>
    </div>
</div>

<hr style="border: none; height: 1px; background: #e5e7eb; margin: 20px 0;">

<div class="card">
    <div class="card-header">
        <h3>Add New Test</h3>
    </div>

    <div id="successMessage" class="success-message"></div>

    <form id="addTestForm">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group">
                <label for="patient">Select Patient *</label>
                <select id="patient" name="patient_id" class="form-select" required>
                    <option value="">Choose a patient...</option>
                    {% for patient in patients %}
                    <option value="{{ patient.id }}">{{ patient.name }} ({{ patient.age }}y, {{ patient.gender }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>Select Test Types * (Multi-Select)</label>
            <div class="test-categories">
                {% for category in categories %}
                <div class="category-group">
                    <div class="category-title" onclick="toggleCategory(this)">
                        <input type="checkbox" class="category-checkbox" data-category="{{ category.name }}" onclick="event.stopPropagation(); toggleCategoryTests(this)">
                        {{ category.name }}
                    </div>
                    {% for test_type in category.test_types.all %}
                    <div class="test-option">
                        <label>
                            <input type="checkbox" name="test_type_ids" value="{{ test_type.id }}" class="test-checkbox" data-category="{{ category.name }}" onchange="updateCategoryCheckbox(this)">
                            {{ test_type.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>

        <button type="submit" class="btn-primary">
            <i class="fas fa-plus-circle"></i> Create Selected Tests
        </button>
    </form>
</div>

<div class="card" style="margin-top: 30px;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3>All Tests</h3>
        <div style="display: flex; gap: 12px;">
            <button onclick="publishSelected()" class="btn-primary" id="publishBtn" style="display: none;">
                <i class="fas fa-check-circle"></i> Publish Selected
            </button>
            <button onclick="deleteSelected()" class="btn-danger" id="deleteBtn" style="display: none;">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>Test Group</th>
                    <th>Patient</th>
                    <th>Report</th>
                    <th>Test Types</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for test_group in draft_test_groups %}
                <tr style="background: #fef3c7;">
                    <td><input type="checkbox" name="test_groups" class="test-checkbox draft-checkbox" value="{{ test_group.0.test_group }}" onchange="updateActionButtons()"></td>
                    <td><strong>{{ test_group.0.test_group }}</strong></td>
                    <td>{{ test_group.0.patient.name }}</td>
                    <td>{{ test_group.0.report.report_id|default:"—" }}</td>
                    <td>
                        {% for test in test_group %}
                            {{ test.test_type.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                        <span style="color: #6b7280;">({{ test_group|length }} test{{ test_group|length|pluralize }})</span>
                    </td>
                    <td>{{ test_group.0.test_date|date:"Y-m-d" }}</td>
                    <td><span class="status-badge draft">DRAFT</span></td>
                    <td style="white-space: nowrap;">
                        <button onclick="openEditModal('{{ test_group.0.test_group }}')" class="btn-secondary" style="margin-right: 8px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTestGroup('{{ test_group.0.test_group }}')" class="btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% for test_group in published_test_groups %}
                <tr>
                    <td><input type="checkbox" name="test_groups" class="test-checkbox published-checkbox" value="{{ test_group.0.test_group }}" onchange="updateActionButtons()"></td>
                    <td><strong>{{ test_group.0.test_group }}</strong></td>
                    <td>{{ test_group.0.patient.name }}</td>
                    <td>{{ test_group.0.report.report_id|default:"—" }}</td>
                    <td>
                        {% for test in test_group %}
                            {{ test.test_type.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                        <span style="color: #6b7280;">({{ test_group|length }} test{{ test_group|length|pluralize }})</span>
                    </td>
                    <td>{{ test_group.0.published_date|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% with worst_status=test_group|dictsort:"status"|last %}
                        <span class="status-badge {{ worst_status.status }}">
                            {{ worst_status.get_status_display }}
                        </span>
                        {% endwith %}
                    </td>
                    <td style="white-space: nowrap;">
                        <button onclick="openEditModal('{{ test_group.0.test_group }}')" class="btn-secondary" style="margin-right: 8px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTestGroup('{{ test_group.0.test_group }}')" class="btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% if not draft_test_groups and not published_test_groups %}
                <tr>
                    <td colspan="7" style="text-align: center; color: #9ca3af;">No tests found</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Test Group Modal -->
<div id="editModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>Edit Test Group</h2>
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px;">
                <strong>Patient:</strong> <span id="modalPatientName"></span> |
                <strong>Test Group:</strong> <span id="modalTestGroup"></span> |
                <strong>Date:</strong> <span id="modalTestDate"></span>
            </div>
            
            <form id="editTestGroupForm">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Test Type</th>
                                <th>Result Value</th>
                                <th>Unit</th>
                                <th>Status</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="modalTestsTable">
                            <!-- Tests will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" onclick="closeEditModal()" class="btn-secondary" style="margin-right: 12px;">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let currentTestGroup = null;
    let currentTests = [];

    // Toggle all tests in a category
    function toggleCategoryTests(checkbox) {
        const category = checkbox.getAttribute('data-category');
        const testCheckboxes = document.querySelectorAll(`input[name="test_type_ids"][data-category="${category}"]`);
        testCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }

    // Update category checkbox based on individual test selections
    function updateCategoryCheckbox(testCheckbox) {
        const category = testCheckbox.getAttribute('data-category');
        const categoryCheckbox = document.querySelector(`.category-checkbox[data-category="${category}"]`);
        const testCheckboxes = document.querySelectorAll(`input[name="test_type_ids"][data-category="${category}"]`);
        const allChecked = Array.from(testCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(testCheckboxes).some(cb => cb.checked);
        
        categoryCheckbox.checked = allChecked;
        categoryCheckbox.indeterminate = someChecked && !allChecked;
    }

    // Toggle category on title click
    function toggleCategory(titleElement) {
        const checkbox = titleElement.querySelector('.category-checkbox');
        checkbox.checked = !checkbox.checked;
        toggleCategoryTests(checkbox);
    }

    // Toggle select all checkboxes
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const allCheckboxes = document.querySelectorAll('input[name="test_groups"]');
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateActionButtons();
    }
    
    // Update action buttons visibility
    function updateActionButtons() {
        const selectedDraftTests = document.querySelectorAll('.draft-checkbox:checked');
        const selectedTests = document.querySelectorAll('input[name="test_groups"]:checked');
        const publishBtn = document.getElementById('publishBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        
        // Show publish button only if draft tests are selected
        publishBtn.style.display = selectedDraftTests.length > 0 ? 'block' : 'none';
        
        // Show delete button if any tests are selected
        deleteBtn.style.display = selectedTests.length > 0 ? 'block' : 'none';
    }

    // Handle form submission for multi-select tests
    document.getElementById('addTestForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const patientId = document.getElementById('patient').value;
        const selectedTests = document.querySelectorAll('input[name="test_type_ids"]:checked');
        
        if (selectedTests.length === 0) {
            showNotification('Please select at least one test type', 'warning');
            return;
        }
        
        const formData = new FormData();
        formData.append('patient_id', patientId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        selectedTests.forEach(test => formData.append('test_type_ids[]', test.value));
        formData.append('result_value', 0);  // Default to 0
        
        fetch("{% url 'add_test' %}", {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const successMsg = document.getElementById('successMessage');
                successMsg.textContent = `Test group created with ${selectedTests.length} test type(s). Click edit to update individual values.`;
                successMsg.style.display = 'block';
                
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while creating the test group.', 'error');
        });
    });
    
    // Open edit modal for test group
    function openEditModal(testGroup) {
        currentTestGroup = testGroup;
        document.getElementById('editModal').style.display = 'block';
        
        // Fetch test group data
        fetch(`{% url 'get_test_group' %}?test_group=${testGroup}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modalPatientName').textContent = data.patient_name;
                document.getElementById('modalTestGroup').textContent = data.test_group;
                document.getElementById('modalTestDate').textContent = data.test_date;
                
                currentTests = data.tests;
                const tbody = document.getElementById('modalTestsTable');
                tbody.innerHTML = '';
                
                data.tests.forEach(test => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${test.test_type_name}</strong></td>
                        <td>
                            <input type="number" 
                                   class="test-result-input" 
                                   data-test-id="${test.test_id}" 
                                   value="${test.result_value}" 
                                   step="0.01" 
                                   required>
                        </td>
                        <td>${test.unit}</td>
                        <td><span class="status-badge ${test.status}">${test.status.toUpperCase()}</span></td>
                        <td>
                            <textarea class="test-notes-input" 
                                      data-test-id="${test.test_id}" 
                                      rows="2">${test.notes}</textarea>
                        </td>
                    `;
                });
            } else {
                showNotification('Error loading test data: ' + data.error, 'error');
                closeEditModal();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while loading test data.', 'error');
            closeEditModal();
        });
    }
    
    // Close edit modal
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        currentTestGroup = null;
        currentTests = [];
    }
    
    // Handle edit form submission
    document.getElementById('editTestGroupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const tests = [];
        const resultInputs = document.querySelectorAll('.test-result-input');
        const notesInputs = document.querySelectorAll('.test-notes-input');
        
        resultInputs.forEach((input, index) => {
            tests.push({
                test_id: input.dataset.testId,
                result_value: parseFloat(input.value),
                notes: notesInputs[index].value
            });
        });
        
        fetch("{% url 'update_test_group' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                test_group: currentTestGroup,
                tests: tests
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${data.count} test(s) updated successfully!`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while updating tests.', 'error');
        });
    });
    
    // Delete test group function
    async function deleteTestGroup(testGroup) {
        const confirmed = await showConfirmDialog(
            'Are you sure you want to delete this entire test group? This action cannot be undone.',
            'Delete Test Group',
            true
        );
        
        if (!confirmed) return;
        
        const formData = new FormData();
        formData.append('test_group', testGroup);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch("{% url 'delete_test' %}", {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Test group deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while deleting the test group.', 'error');
        });
    }
    
    // Publish selected test groups
    function publishSelected() {
        const selectedGroups = Array.from(document.querySelectorAll('.draft-checkbox:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedGroups.length === 0) {
            showNotification('Please select at least one test group to publish', 'warning');
            return;
        }
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        selectedGroups.forEach(id => formData.append('test_groups[]', id));
        
        fetch("{% url 'publish_tests' %}", {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${selectedGroups.length} test group(s) published successfully!`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while publishing test groups.', 'error');
        });
    }
    
    // Delete selected test groups
    async function deleteSelected() {
        const selectedGroups = Array.from(document.querySelectorAll('input[name="test_groups"]:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedGroups.length === 0) {
            showNotification('Please select at least one test group to delete', 'warning');
            return;
        }
        
        const confirmed = await showConfirmDialog(
            `Are you sure you want to delete ${selectedGroups.length} test group(s)? This action cannot be undone.`,
            'Delete Test Groups',
            true
        );
        
        if (!confirmed) return;
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        selectedGroups.forEach(id => formData.append('test_groups[]', id));
        
        fetch("{% url 'bulk_delete_tests' %}", {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${selectedGroups.length} test group(s) deleted successfully!`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while deleting test groups.', 'error');
        });
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
            closeEditModal();
        }
    }
</script>
{% endblock %}
